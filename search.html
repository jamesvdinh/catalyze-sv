<!doctype html>
<html class="no-js" lang="en">

<!-- Housing Development Search Tool -->

<head>
  <meta charset="utf-8">
  <title>Search Projects</title>
  <meta name="description" content="Find nearby Shape SV projects in Silicon Valley">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">
  <script src='https://unpkg.com/@turf/turf/turf.min.js'></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
  <style>
    body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        margin: 0;
        box-sizing: border-box;
    }

    .search-container {
        margin: 0 auto 20px;
        padding: 0 20px;
        justify-content: center;
        text-align: center;
        max-width: 980px;
    }

    .heading {
        width: 100%;
        margin: 20px 0;
    }

    .subtitle {
        margin: 0 auto 15px;
    }

    .search-menu {
        display: flex;
        flex-flow: row wrap;
        margin: 0 auto 10px;
        justify-content: left;
    }

    .search-filter {
        margin: 10px 5px;
        text-align: left;
    }

    .search-filter select {
        width: 85px;
        border-radius: 50px;
        padding-left: 5px;
        color: rgb(132, 132, 132);
        font-size: 16px;
    }

    .search-filter select:hover, .search-filter select:focus {
        background-color: aliceblue;
        cursor: pointer;
    }

    .search-select {
        height: 36px;
    }

    .project-list {
        display: flex;
        flex-flow: row wrap;
        margin: auto;
        justify-content: center;
        margin-top: 10px;
    }

    .text-container {
        padding: 10px;
        text-align: left;
    }

    .project-name {
        margin: 5px 0;
        color: #0D4197;
    }

    .project-city {
        margin: 5px 0;
    }

    .project-city {
        display: flex;
        align-items: center;
    }

    .project-img {
        max-height: 180px;
        object-fit: cover;
        width: 100%;
    }

    .project-feedbackNeeded {
        font-size: 12px;
        margin: 0;
        border-radius: 50px;
        padding: 3px 7px;
        background-color: rgb(255, 237, 237);
        color: coral;
        font-weight: bold;
        width: fit-content;
    }

    .project-numFeedbacks, .project-numParticipants {
        /* position: absolute;
        bottom: 0;
        right: 0; */
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 0;
    }

    .numFeedbacks-icon {
        margin-top: 4px;
        padding-right: 5px;
        stroke: coral;
        width: 28px;
        height: 28px;
    }

    .project-link-a {
        text-decoration: none;
        color: rgb(66, 142, 205);
    }

    .project-link {
        text-decoration: none;
        color: black;
        background-color: orangered;
        padding: 7px 30px;
        border-radius: 50px;
        color: white;
        text-align: center;
        border: unset;
        font-size: 16px;
    }

    .project-link:hover {
        filter: brightness(0.9);
        transition: all 0.2s;
    }

    .project-coordinates, .project-type, .project-status {
        display: none;
    }

    .project-entry {
        position: relative;
        margin: 20px 5px;
        max-width: 310px;
        display: flex;
        flex-flow: column wrap;
        text-align: left;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 0 1px gray;
    }

    .mapboxgl-ctrl-geocoder {
        border-radius: 50px;
        box-shadow: unset;
        border: 1px solid black;
        min-width: 280px;
        font-size: 16px;
        height: 36px;
        display: flex;
    }
    .mapboxgl-ctrl-geocoder--input:focus {
        outline: unset;
    }
    .mapboxgl-ctrl-geocoder--input {
        color: unset;
        font-size: 16px;
    }
    .mapboxgl-ctrl-geocoder--input::placeholder {
        font-size: 16px;
    }
    .mapboxgl-ctrl-geocoder--icon {
        top: 7px;
    }
    @media screen and (min-width: 640px) {
        .mapboxgl-ctrl-geocoder {
            font-size: unset;
            line-height: unset;
            max-width: unset;
        }
        .mapboxgl-ctrl-geocoder--input {
            color: unset;
            font-size: 14px;
        }
    }
    .submit-button {
        margin: 10px 7px 3px;
        text-align: center;
        padding: 7px 30px;
        border-radius: 50px;
        background-color: orangered;
        border: unset;
        color: white;
        cursor: pointer;
        height: 36px;
        font-size: 16px;
    }

    .submit-button:hover {
        filter: brightness(0.9);
        transition: all 0.2s;
    }

    .user-buttons {
        display: flex;
        flex-flow: row nowrap;
        margin: none;
    }

    .clear-filters {
        border: unset;
        background-color: unset;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .clear-filters-text {
        margin-left: 3px;
        font-size: 16px;
    }

    .clear-filters:hover {
        text-decoration: underline;
    }

    .project-quantity-container {
        display: flex;
        justify-content: space-between;
    }

    .icon-container {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .inline-svg {
        margin-right: 2px;
    }

    .results {
        text-align: left;
        font-size: 16px;
        margin-left: 7px;
    }

    .project-desc {
        height: 105px;
    }
  </style>
</head>

<body>
    <section class="search-container">
        <div class="search-menu">
            <div class="search-filter">
                <div id="geocoder"></div>
            </div>
            <div class="search-filter">
                <select class="search-select" id="radius" name="radius" disabled></select>
            </div>
            <div class="search-filter">
                <select class="search-select" id="type" name="type"></select>
            </div>
            <div class="search-filter">
                <select class="search-select" id="status" name="status"></select>
            </div>
            <div class="user-buttons">
                <button class="submit-button" id="submit-button" onclick="update_list()" disabled>Search</button>
                <button class="clear-filters" onclick="resetFilters(); restore_list()">
                    <svg width="12px" height="12px" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" stroke-width="3" stroke="#000000" fill="none"><path d="M53.72,36.61A21.91,21.91,0,1,1,50.37,20.1"/><polyline points="51.72 7.85 50.85 20.78 37.92 19.9"/><path d="M53.72,36.61A21.91,21.91,0,1,1,50.37,20.1"/><polyline points="51.72 7.85 50.85 20.78 37.92 19.9"/></svg>
                    <span class="clear-filters-text" id=".clear-filters-text">clear all filters</span>
                </button>
            </div>
        </div>
        <div class="results" id="results"></div>
    </section>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>

    <script>
        const MAPBOX_KEY = 'pk.eyJ1IjoiY2F0YWx5emVzdiIsImEiOiJjazZ4d2RoN2gwa2QyM2tydnF6dG1zbjNrIn0.erXugBYot80KgmE2egMXCA';
        let addressCoordinates = [];
        let totalProjectNum = 0;
        
        function createList() {
            let list = document.createElement('div');
            list.classList.add('project-list');
            list.setAttribute('id','project-list');
            fetch('https://alexshoor.wixsite.com/shapesvalpha/_functions/collectionItems/collectionName=Version7CSVProjects', {
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {             
                data.items.forEach((current_project, i) => {
                    const project_img = current_project.genericImage;
                    const project_feedbackNeeded = current_project.feedbackNeeded;
                    const project_name = current_project.projectName;
                    const project_address = current_project.projectAddress;
                    const project_type = current_project["projectType(Select 1)"];
                    const project_status = current_project.currentStatus;
                    const project_city = current_project.city;
                    const project_link = current_project["link-version7csvprojects-projectName"];
                    const project_numFeedbacks = current_project["numberofFeedbacks(Internal)"];
                    const project_desc = current_project.highlight1;
                    const project_numParticipants = current_project["numberofFeedbacks(Internal)"];

                    let current_item = document.createElement('div');
                    current_item.classList.add('project-entry');

                    const text_container = document.createElement('div');
                    text_container.classList.add('text-container');

                    const img = document.createElement('img');
                    img.src = project_img;
                    img.classList.add('project-img');

                    const feedbackNeeded = document.createElement('p');
                    feedbackNeeded.textContent = [project_feedbackNeeded];
                    feedbackNeeded.classList.add('project-feedbackNeeded');

                    const nameLink = document.createElement('a');
                    nameLink.href = project_link;
                    nameLink.classList.add('project-link-a');
                    const name = document.createElement('h3');
                    name.textContent = `${project_name}`;
                    name.classList.add('project-name');
                    nameLink.append(name);

                    const address = document.createElement('h4');
                    address.textContent = project_address;
                    address.classList.add('project-address');

                    const city = document.createElement('p');
                    city.innerHTML = `<svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 21C15.5 17.4 19 14.1764 19 10.2C19 6.22355 15.866 3 12 3C8.13401 3 5 6.22355 5 10.2C5 14.1764 8.5 17.4 12 21Z" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 12C13.1046 12 14 11.1046 14 10C14 8.89543 13.1046 8 12 8C10.8954 8 10 8.89543 10 10C10 11.1046 10.8954 12 12 12Z" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>` + project_city;
                    city.classList.add('project-city');

                    const type = document.createElement('p');
                    type.textContent = project_type;
                    type.classList.add('project-type');

                    const status = document.createElement('p');
                    status.textContent = project_status;
                    status.classList.add('project-status');

                    const distance = document.createElement('p');
                    distance.classList.add('project-distance');

                    const desc = document.createElement('p');
                    desc.textContent = project_desc;
                    desc.classList.add('project-desc');

                    const quantity_container = document.createElement('div');
                    quantity_container.classList.add('project-quantity-container');

                    const numFeedbacks = document.createElement('div');
                    numFeedbacks.classList.add('icon-container');
                    const numFeedbacksText = document.createElement('span');
                    numFeedbacksText.innerHTML = project_numFeedbacks;
                    numFeedbacks.innerHTML = `<svg class="inline-svg numFeedbacks-icon" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" stroke-width="3" stroke="#000000" fill="none"><circle cx="31.89" cy="22.71" r="5.57"/><path d="M43.16,43.74A11.28,11.28,0,0,0,31.89,32.47h0A11.27,11.27,0,0,0,20.62,43.74Z"/><circle cx="48.46" cy="22.71" r="5.57"/><path d="M46.87,43.74H59.73A11.27,11.27,0,0,0,48.46,32.47h0a11.24,11.24,0,0,0-5.29,1.32"/><circle cx="15.54" cy="22.71" r="5.57"/><path d="M17.13,43.74H4.27A11.27,11.27,0,0,1,15.54,32.47h0a11.24,11.24,0,0,1,5.29,1.32"/></svg>`;
                    numFeedbacks.append(numFeedbacksText);
                    numFeedbacks.classList.add('project-numFeedbacks');

                    const link = document.createElement('a');
                    link.textContent = "More";
                    link.href = project_link;
                    link.classList.add('project-link');

                    quantity_container.append(link, numFeedbacks);

                    const coordinates = document.createElement('p');
                    getCoordinates(project_address).then(response => {
                        coordinates.textContent = response;
                    });
                    coordinates.classList.add('project-coordinates');

                    text_container.append(feedbackNeeded, nameLink, city, desc, distance, quantity_container, type, status, coordinates);

                    current_item.append(img, text_container);
                    list.append(current_item);
                });
                const results = document.getElementById('results');
                results.after(list);
                const list_items = list.getElementsByClassName('project-entry');
                Array.from(list_items)
                    .sort((a, b) => a.getElementsByClassName('project-name')[0].textContent.localeCompare(b.getElementsByClassName('project-name')[0].textContent))
                    .forEach(item => list.appendChild(item));
            }).then(() => {
            	document
              .querySelector(".project-list")
              .addEventListener("click", (e) => {
                if (e.target.classList.contains("project-link")) {
                  e.preventDefault();
                  const projectLink = e.target.getAttribute("href");
                  window.parent.postMessage(projectLink, "https://alexshoor.wixsite.com");
                }
              });
            })
        }

        function search() {
            const geocoder = new MapboxGeocoder({
                accessToken: MAPBOX_KEY,
                countries: 'us',
                proximity: [-121.898395, 37.322972],
                localGeocoder: forwardGeocoder,
                placeholder: "Search by city, project name",
            });

            const search_bar = document.getElementById('geocoder');
            geocoder.addTo(search_bar);

            const search_input = search_bar.getElementsByTagName('input')[0];
            let search_enabled = false;
            let address_coords = [0,0];

            // Radius input
            const radius = document.getElementById('radius');
            const options = `
                <option value="" disabled selected>Radius</option>
                <option value="All">All</option>
                <option value="1">1 mi</option>
                <option value="2">2 mi</option>
                <option value="5">5 mi</option>
                <option value="10">10 mi</option>
                <option value="15">15 mi</option>
                <option value="20">20 mi</option>
                <option value="25">25 mi</option>
            `
            radius.innerHTML += options;

            const type = document.getElementById('type');
            const type_options = `
                <option value="" disabled selected>Type</option>
                <option value="All">All</option>
                <option value="100% Affordable">100% Affordable</option>
                <option value="Hotel">Hotel</option>
                <option value="Office Space">Office Space</option>
                <option value="Residential U">Residential U</option>
                <option value="Retail Space">Retail Space</option>
                <option value="Some Affordable">Some Affordable</option>
            `
            type.innerHTML += type_options;

            const status = document.getElementById('status');
            const status_options = `
                <option value="" disabled selected>Status</option>
                <option value="All">All</option>
                <option value="In Design">In Design</option>
            `

            status.innerHTML += status_options;

            radius.addEventListener(
                'change',
                function() { checkFilled(); }
            );
            type.addEventListener(
                'change',
                function() { checkFilled(); }
            );
            status.addEventListener(
                'change',
                function() { checkFilled(); }
            );
            // Get the geocoder results container.
            let results = document.getElementById('results');

            // Add geocoder result to container.
            geocoder.on('result', (e) => {
                search_enabled = true;
                const radius_val = radius.value;
                address_coords = e.result.center;
                addressCoordinates = address_coords;
                radius.disabled = false;
                checkFilled();
            });
            
            // Clear results container when search is cleared.
            geocoder.on('clear', () => {
                results.innerText = '';
                restore_list();
            });

            let customData = {
                'features': [],
                'type': 'FeatureCollection'
            };
            
            fetch('https://alexshoor.wixsite.com/shapesvalpha/_functions/collectionItems/collectionName=Version7CSVProjects', {
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {           
                data.items.forEach((current_project, i) => {
                    const project_name = current_project.projectName;
                    getCoordinates(current_project.projectAddress).then(coords => {
                        const dataEntry = {
                        'type': 'Feature',
                        'properties': {
                            'title': project_name
                        },
                        'geometry': {
                            'coordinates': coords,
                            'type': 'Point'
                        }
                    };
                    customData['features'].push(dataEntry);
                    });
                });
                totalProjectNum = data.items.length;
                results.innerText = `Active Projects (${totalProjectNum})`;
            })

            function forwardGeocoder(query) {
                const matchingFeatures = [];
                for (const feature of customData["features"]) {
                // Handle queries with different capitalization
                // than the source data by calling toLowerCase().
                if (
                feature.properties.title
                .toLowerCase()
                .includes(query.toLowerCase())
                ) {
                    // Add a tree emoji as a prefix for custom
                    // data results using carmen geojson format:
                    // https://github.com/mapbox/carmen/blob/master/carmen-geojson.md
                    feature['place_name'] = `${feature.properties.title} ✅`;
                    feature['center'] = feature.geometry.coordinates;
                    matchingFeatures.push(feature);
                }
                }
                return matchingFeatures;
            }
        }

        function getCoordinates(address) {
            return fetch("https://api.mapbox.com/geocoding/v5/mapbox.places/" + address + ".json?proximity=-121.898395,37.322972&country=US&access_token=" + MAPBOX_KEY, {
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(geocoderResult => {
                return geocoderResult.features[0].center;
            });
        }

        function update_list() {
            const project_list = document.getElementById('project-list');
            const list_items = project_list.getElementsByClassName('project-entry');
            const result = addressCoordinates;
            const radius = document.getElementById('radius').value;
            const type = document.getElementById('type').value;
            const status = document.getElementById('status').value;
            
            let count = 0;
            for (i = 0; i < list_items.length; i++) {
                const name = list_items[i].getElementsByClassName('project-name')[0].innerText;
                const coords = list_items[i].getElementsByClassName('project-coordinates')[0].innerText.split(',');
                const project_type = list_items[i].getElementsByClassName('project-type')[0].innerText;
                const project_status = list_items[i].getElementsByClassName('project-status')[0].innerText;

                const distance = find_distance(result, coords);

                const distance_rounded = Math.round(distance * 10) / 10;
                if ((radius !== "All" ? (distance > radius) : "") 
                    || (type !== "All" ? (project_type !== type) : "") 
                    || (status !== "All" ? (project_status !== status) : "")) {
                    list_items[i].style.display = "none";
                }
                else if (distance === 0) {
                    list_items[i].style.backgroundColor = "#def4f4";
                    list_items[i].getElementsByClassName('project-distance')[0].innerText = distance_rounded + " mi away (project match!)";
                    count += 1;
                }
                else {
                    list_items[i].style.display = "flex";
                    list_items[i].getElementsByClassName('project-distance')[0].innerText = distance_rounded + " mi away";
                    count += 1;
                }
            }

            results.innerText = `Active Projects (${count})`;

            Array.from(list_items)
                .sort((a, b) => a.getElementsByClassName('project-distance')[0].innerText.localeCompare(b.getElementsByClassName('project-distance')[0].innerText))
                .forEach(item => project_list.appendChild(item));
        }

        function restore_list() {
            const project_list = document.getElementById('project-list');
            const list_items = project_list.getElementsByClassName('project-entry');
            const results = document.getElementById('results');
            const radius = document.getElementById('radius');

            radius.disabled = true;

            results.innerText = `Active Projects (${totalProjectNum})`;

            for (i = 0; i < list_items.length; i++) {
                list_items[i].style.display = "block";
                list_items[i].style.backgroundColor = "unset";
                // list_items[i].getElementsByClassName('project-distance')[0].innerText = "";
                list_items[i].getElementsByClassName('project-distance')[0].display = "none";
            }
            checkFilled();
        }

        function find_distance(startCoords, endCoords) {
            const from = turf.point(startCoords);
            const to = turf.point(endCoords);
            const options = {units: 'miles'};

            return turf.distance(from, to, options);
            }

        document.addEventListener('DOMContentLoaded', function() {
            createList();
            search();
        }, false);

        function resetFilters() {
            const inputElementIDs = [
                'radius',
                'type',
                'status'
            ]
            inputElementIDs.map(id => {
                document.getElementById(id).value = "";
            })
            document.getElementsByClassName('mapboxgl-ctrl-geocoder--input')[0].value = "";
        }

        function checkFilled() {
            let isFilled = true;
            const inputElementIDs = [
                'radius',
                'type',
                'status'
            ]

            if (document.getElementsByClassName('mapboxgl-ctrl-geocoder--input')[0].value === "") {
                isFilled = false;
            };

            inputElementIDs.map(id => {
                if (document.getElementById(id).value === "") {
                    isFilled = false;
                }
            })

            if (isFilled) {
                document.getElementById('submit-button').disabled = false;
            }
            else {
                document.getElementById('submit-button').disabled = true;
                return;
            }
        }

    </script>
</body>

</html>